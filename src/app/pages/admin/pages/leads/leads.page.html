<div class="leads-page">
  <header class="page-header">
    <div class="page-header-content">
      <h1>Управление лидами</h1>
      <p>Создавайте и управляйте лидами от клиентов</p>
    </div>
    <div class="page-header-actions">
      <button class="btn btn-primary" (click)="openCreateModal()">
        <i class="fas fa-plus"></i>
        Создать лид
      </button>
    </div>
  </header>

  <!-- Фильтры -->
  <div class="filters-panel">
    <div class="filter-group">
      <label>Статус:</label>
      <select [(ngModel)]="filterStatus" (change)="applyFilters()">
        <option value="">Все</option>
        <option value="new">Новый</option>
        <option value="in_progress">В работе</option>
        <option value="contacted">Связались</option>
        <option value="closed">Закрыт</option>
        <option value="lost">Потерян</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Источник:</label>
      <select [(ngModel)]="filterSource" (change)="applyFilters()">
        <option value="">Все</option>
        <option value="chat">Чат</option>
        <option value="telegram">Telegram</option>
        <option value="phone">Телефон</option>
        <option value="email">Email</option>
        <option value="other">Другое</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Назначен:</label>
      <select [(ngModel)]="filterAdmin" (change)="applyFilters()">
        <option [value]="null">Все</option>
        <option *ngFor="let admin of admins" [value]="admin.id">{{ admin.email }}</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Поиск:</label>
      <input 
        type="text" 
        [(ngModel)]="searchQuery" 
        (keyup.enter)="applyFilters()"
        placeholder="Имя, email, телефон...">
    </div>
    <button class="btn btn-secondary" (click)="clearFilters()">Сбросить</button>
  </div>

  <!-- Таблица лидов -->
  @if (isLoading()) {
    <div class="loading">Загрузка...</div>
  } @else if (leads().length === 0) {
    <div class="empty-state">
      <i class="fas fa-inbox"></i>
      <p>Лиды не найдены</p>
    </div>
  } @else {
    <div class="table-card">
      <table class="table table-hover align-middle data-table">
        <thead>
          <tr>
            <th>Имя</th>
            <th>Контакты</th>
            <th>Источник</th>
            <th>Статус</th>
            <th>Приоритет</th>
            <th>Score</th>
            <th>Назначен</th>
            <th>Дата создания</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody>
          @for (lead of leads(); track lead.id) {
            <tr 
              class="lead-row" 
              (click)="openDetailsModal(lead, $event)"
              [attr.data-lead-id]="lead.id"
              style="cursor: pointer;">
              <td data-label="Имя">
                <div class="lead-name-cell">
                  <strong>{{ lead.name }}</strong>
                  @if (lead.hasTelegramContact) {
                    <span class="telegram-indicator" title="Есть Telegram контакт">
                      <i class="fab fa-telegram"></i>
                    </span>
                  }
                  @if (lead.tags && lead.tags.length > 0) {
                    <div class="tags-preview">
                      @for (tag of lead.tags.slice(0, 2); track tag.id) {
                        <span class="tag-badge" [style.background-color]="tag.color">{{ tag.name }}</span>
                      }
                      @if (lead.tags.length > 2) {
                        <span class="tag-more">+{{ lead.tags.length - 2 }}</span>
                      }
                    </div>
                  }
                </div>
              </td>
              <td data-label="Контакты">
                <div class="contacts-cell">
                  @if (lead.phone) {
                    <div class="contact-item">
                      <i class="fas fa-phone"></i>
                      <span>{{ lead.phone }}</span>
                    </div>
                  }
                  @if (lead.email) {
                    <div class="contact-item">
                      <i class="fas fa-envelope"></i>
                      <span>{{ lead.email }}</span>
                    </div>
                  }
                </div>
              </td>
              <td data-label="Источник">
                <span class="source-badge">
                  <i class="fas" 
                    [ngClass]="{
                      'fa-comments': lead.source === 'chat',
                      'fa-paper-plane': lead.source === 'telegram',
                      'fa-phone': lead.source === 'phone',
                      'fa-envelope': lead.source === 'email',
                      'fa-question': lead.source === 'other'
                    }"></i>
                  {{ getSourceLabel(lead.source) }}
                </span>
              </td>
              <td data-label="Статус">
                <span class="status-badge" [class]="getStatusClass(lead.status)">
                  {{ getStatusLabel(lead.status) }}
                </span>
              </td>
              <td data-label="Приоритет">
                <span class="priority-badge" [class]="getPriorityClass(lead.priority)">
                  {{ getPriorityLabel(lead.priority) }}
                </span>
              </td>
              <td data-label="Score">
                <div class="score-cell">
                  <span class="score-value" [class]="getScoreClass(lead.score || 0)">
                    {{ lead.score || 0 }}
                  </span>
                </div>
              </td>
              <td data-label="Назначен">
                @if (lead.assignedAdmin) {
                  <span class="assigned-admin">
                    <i class="fas fa-user"></i>
                    {{ lead.assignedAdmin.email }}
                  </span>
                } @else {
                  <span class="not-assigned">Не назначен</span>
                }
              </td>
              <td data-label="Дата создания">
                <span class="date-cell">{{ formatDate(lead.createdAt) }}</span>
              </td>
              <td data-label="Действия" (click)="$event.stopPropagation()">
                <div class="action-menu">
                  <button 
                    class="btn btn-sm btn-secondary" 
                    (click)="openEditModal(lead)"
                    title="Редактировать">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button 
                    class="btn btn-sm btn-danger" 
                    (click)="deleteLead(lead)"
                    title="Удалить">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>
