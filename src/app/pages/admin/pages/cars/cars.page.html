@if (cars && admin) {
  <section class="cars-page animate-fade-in">
    <header class="page-header-glass animate-slide-in-top">
      <div class="page-header-text">
        <span class="eyebrow-label">
          <i class="fas fa-warehouse"></i>
          Автопарк
        </span>
        <h2 class="page-title">Управление автомобилями</h2>
        <p class="page-subtitle">
          Отслеживайте доступность, статус продаж и обновляйте карточки автомобилей в один клик.
        </p>
      </div>
      <div class="page-header-actions">
        <div class="stats-chip">
          <i class="fas fa-car-side"></i>
          <span>{{ cars.length }}</span>
          <small>в базе</small>
        </div>
        <button class="btn btn-lion" type="button" (click)="openModal()">
          <i class="fas fa-plus"></i>
          <span>Добавить автомобиль</span>
        </button>
      </div>
    </header>

    <div class="metrics-grid animate-scale-in">
      <div class="metric-card glass-card">
        <div class="metric-icon success">
          <i class="fas fa-bolt"></i>
        </div>
        <div class="metric-content">
          <span class="metric-label">Активно</span>
          <strong class="metric-value">{{ activeCarsCount }}</strong>
        </div>
      </div>
      <div class="metric-card glass-card">
        <div class="metric-icon warning">
          <i class="fas fa-tags"></i>
        </div>
        <div class="metric-content">
          <span class="metric-label">Продано</span>
          <strong class="metric-value">{{ soldCarsCount }}</strong>
        </div>
      </div>
      <div class="metric-card glass-card">
        <div class="metric-icon danger">
          <i class="fas fa-trash-restore"></i>
        </div>
        <div class="metric-content">
          <span class="metric-label">Удалено</span>
          <strong class="metric-value">{{ deletedCarsCount }}</strong>
        </div>
      </div>
    </div>

    @if (cars.length === 0) {
      <div class="data-empty animate-fade-in">
        <i class="fas fa-car-crash"></i>
        <h3>Автомобили не найдены</h3>
        <p>Добавьте первый автомобиль, чтобы начать наполнять каталог.</p>
      </div>
    } @else {
      <div class="table-card glass-card animate-slide-in-bottom">
        <table class="table table-hover align-middle data-table">
          <thead>
            <tr>
              <th>Автомобиль</th>
              <th>Фото</th>
              <th>Статус</th>
              <th>Действия</th>
              @if (admin.isSuper) {
                <th>Автор</th>
              }
            </tr>
          </thead>
          <tbody>
            @for (car of cars; track car; let index = $index) {
              <tr [class.table-danger]="car.deletedAt" class="animate-fade-in">
                <td data-label="Автомобиль">
                  <div class="car-meta">
                    <div class="car-name">
                      <strong>{{ car.brand }} {{ car.model }}</strong>
                      <span class="car-year">{{ car.year }}</span>
                    </div>
                    @if (car.vin) {
                      <span class="car-vin">
                        <i class="fas fa-fingerprint"></i>
                        {{ car.vin }}
                      </span>
                    }
                  </div>
                </td>
                <td data-label="Фото">
                  @if (car.files?.length > 0) {
                    <div class="car-thumb">
                      <img
                        [ngSrc]="appService.getFileUrl(car.files[0])"
                        alt="car"
                        height="80"
                        width="120"
                        [priority]="index < 10"
                      />
                    </div>
                  } @else {
                    <div class="car-thumb placeholder">
                      <i class="fas fa-image"></i>
                      <small>Нет фото</small>
                    </div>
                  }
                </td>
                <td data-label="Статус">
                  <span
                    class="status-pill"
                    [ngClass]="{
                      success: !car.deletedAt && !car.isSold,
                      warning: !car.deletedAt && car.isSold,
                      danger: car.deletedAt
                    }"
                  >
                    <i
                      class="fas"
                      [ngClass]="{
                        'fa-check-circle': !car.deletedAt && !car.isSold,
                        'fa-award': !car.deletedAt && car.isSold,
                        'fa-ban': car.deletedAt
                      }"
                    ></i>
                    @if (car.deletedAt) {
                      Удалена
                    } @else if (car.isSold) {
                      Продана
                    } @else {
                      Активна
                    }
                  </span>
                </td>
                <td data-label="Действия">
                  <div class="action-menu">
                    @if (!car.deletedAt) {
                      <button
                        type="button"
                        class="btn btn-ghost btn-action accent"
                        (click)="openModal(car)"
                      >
                        <i class="fas fa-edit"></i>
                        <span>Редактировать</span>
                      </button>

                      @if (!car.isSold) {
                        <button
                          type="button"
                          class="btn btn-ghost btn-action warning"
                          (click)="markAsSold(car)"
                        >
                          <i class="fas fa-check-circle"></i>
                          <span>Продана</span>
                        </button>
                      } @else {
                        <button
                          type="button"
                          class="btn btn-ghost btn-action success"
                          (click)="markAsAvailable(car)"
                        >
                          <i class="fas fa-undo"></i>
                          <span>Доступна</span>
                        </button>
                      }

                      @if (admin.isSuper || car.adminId === admin.id) {
                        <button
                          type="button"
                          class="btn btn-ghost btn-action danger"
                          (click)="deleteCar(car)"
                        >
                          <i class="fas fa-times"></i>
                          <span>Удалить</span>
                        </button>
                      }
                    } @else if (admin.isSuper) {
                      <button
                        type="button"
                        class="btn btn-ghost btn-action accent"
                        (click)="restoreCar(car)"
                      >
                        <i class="fas fa-trash-restore"></i>
                        <span>Восстановить</span>
                      </button>
                    }
                  </div>
                </td>
                @if (admin.isSuper) {
                  <td data-label="Автор">
                    @if (car.admin) {
                      <div class="car-author">
                        <i class="fas fa-user-circle"></i>
                        <span>{{ car.admin.email }}</span>
                      </div>
                    } @else {
                      <span class="author-missing">Не указан</span>
                    }
                  </td>
                }
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </section>
}
