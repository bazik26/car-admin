@if (isLoading()) {
  <div class="modal-body text-center p-5">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Загрузка...</span>
    </div>
    <p class="mt-3">Загрузка данных администратора...</p>
  </div>
} @else if (adminData(); as admin) {
  <div class="admin-details-modal">
    <!-- Modal Header -->
    <div class="modal-header">
      <div class="d-flex align-items-center justify-content-between w-100">
        <div>
          <h4 class="mb-0">{{ admin.email }}</h4>
          @if (admin.isSuper) {
            <span class="badge bg-warning text-dark ms-2">
              <i class="fas fa-crown"></i> Супер-администратор
            </span>
          }
        </div>
        <button type="button" class="btn-close" (click)="closeModal()" aria-label="Close"></button>
      </div>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">
      <!-- Tabs Navigation -->
      <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item" role="presentation">
          <button 
            class="nav-link" 
            [class.active]="activeTab() === 'info'"
            (click)="onTabChange('info')"
            type="button">
            <i class="fas fa-info-circle me-2"></i>Информация
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button 
            class="nav-link" 
            [class.active]="activeTab() === 'stats'"
            (click)="onTabChange('stats')"
            type="button">
            <i class="fas fa-chart-bar me-2"></i>Статистика
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      @if (activeTab() === 'info') {
        @if (!isEditing()) {
        <!-- Режим просмотра -->
        <div class="info-section mb-4">
          <h5 class="mb-3">Основная информация</h5>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Email</label>
              <div class="fw-bold">{{ admin.email }}</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Статус</label>
              <div>
                <span class="badge" [class.bg-success]="!admin.deletedAt" [class.bg-danger]="admin.deletedAt">
                  {{ admin.deletedAt ? 'Удален' : 'Активен' }}
                </span>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Роль</label>
              <div>
                <span class="badge" [class.bg-warning]="admin.isSuper" [class.bg-secondary]="!admin.isSuper">
                  {{ admin.isSuper ? 'Супер-администратор' : 'Менеджер' }}
                </span>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Дата создания</label>
              <div>{{ formatDate(admin.createdAt) }}</div>
            </div>
          </div>
        </div>

        <div class="info-section mb-4">
          <h5 class="mb-3">Принадлежность к проекту</h5>
          <div class="row g-3">
            <div class="col-md-12">
              <label class="form-label">Проект</label>
              <div>
                <span class="badge bg-info">
                  {{ getProjectLabel(admin.projectId) }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <div class="info-section mb-4">
          <h5 class="mb-3">Разрешения</h5>
          <div class="permissions-list">
            <div class="permission-item">
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <i class="fas fa-car text-primary me-2"></i>
                  <span>Добавлять автомобили</span>
                </div>
                <span class="badge" [class.bg-success]="admin.permissions?.canAddCars" [class.bg-secondary]="!admin.permissions?.canAddCars">
                  {{ admin.permissions?.canAddCars ? 'Разрешено' : 'Запрещено' }}
                </span>
              </div>
            </div>
            <div class="permission-item">
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <i class="fas fa-eye text-primary me-2"></i>
                  <span>Просматривать автомобили</span>
                </div>
                <span class="badge" [class.bg-success]="admin.permissions?.canViewCars" [class.bg-secondary]="!admin.permissions?.canViewCars">
                  {{ admin.permissions?.canViewCars ? 'Разрешено' : 'Запрещено' }}
                </span>
              </div>
            </div>
            <div class="permission-item">
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <i class="fas fa-user-tie text-primary me-2"></i>
                  <span>Обслуживать лидов (с редактированием)</span>
                </div>
                <span class="badge" [class.bg-success]="admin.permissions?.canManageLeads" [class.bg-secondary]="!admin.permissions?.canManageLeads">
                  {{ admin.permissions?.canManageLeads ? 'Разрешено' : 'Запрещено' }}
                </span>
              </div>
            </div>
            <div class="permission-item">
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <i class="fas fa-eye text-primary me-2"></i>
                  <span>Смотреть лидов (без редактирования)</span>
                </div>
                <span class="badge" [class.bg-success]="admin.permissions?.canViewLeads" [class.bg-secondary]="!admin.permissions?.canViewLeads">
                  {{ admin.permissions?.canViewLeads ? 'Разрешено' : 'Запрещено' }}
                </span>
              </div>
            </div>
          </div>
        </div>

        @if (admin.permissions?.canManageLeads || admin.isSuper) {
          <div class="info-section mb-4">
            <h5 class="mb-3">Рабочие часы</h5>
            <div class="d-flex align-items-center justify-content-between">
              <div>
                @if (hasWorkingHours()) {
                  <span class="badge bg-success">
                    <i class="fas fa-check me-1"></i>Настроены
                  </span>
                  <p class="text-muted mb-0 mt-2 small">
                    Рабочие часы настроены. Нажмите кнопку ниже для редактирования.
                  </p>
                } @else {
                  <span class="badge bg-warning text-dark">
                    <i class="fas fa-exclamation-triangle me-1"></i>Не настроены
                  </span>
                  <p class="text-muted mb-0 mt-2 small">
                    Рабочие часы не настроены. Настройте их для автоматического назначения задач.
                  </p>
                }
              </div>
              <button type="button" class="btn btn-primary btn-sm" (click)="openWorkingHoursModal()">
                <i class="fas fa-clock me-1"></i>
                {{ hasWorkingHours() ? 'Изменить' : 'Настроить' }} рабочие часы
              </button>
            </div>
          </div>
        }
      } @else {
        <!-- Режим редактирования -->
        <div class="info-section mb-4">
          <h5 class="mb-3">Редактирование информации</h5>
          
          <div class="mb-3">
            <label class="form-label">Принадлежность к проекту</label>
            <select class="form-select" [(ngModel)]="editForm.projectId">
              <option value="">Не назначен</option>
              <option value="office_1">Офис 1</option>
              <option value="office_2">Офис 2</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Разрешения</label>
            <div class="permissions-edit">
              <div class="form-check mb-2">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  id="canAddCars"
                  [(ngModel)]="editForm.permissions.canAddCars">
                <label class="form-check-label" for="canAddCars">
                  <i class="fas fa-car me-2"></i>Добавлять автомобили
                </label>
              </div>
              <div class="form-check mb-2">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  id="canViewCars"
                  [(ngModel)]="editForm.permissions.canViewCars">
                <label class="form-check-label" for="canViewCars">
                  <i class="fas fa-eye me-2"></i>Просматривать автомобили
                </label>
              </div>
              <div class="form-check mb-2">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  id="canManageLeads"
                  [(ngModel)]="editForm.permissions.canManageLeads">
                <label class="form-check-label" for="canManageLeads">
                  <i class="fas fa-user-tie me-2"></i>Обслуживать лидов (с редактированием)
                </label>
              </div>
              <div class="form-check mb-2">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  id="canViewLeads"
                  [(ngModel)]="editForm.permissions.canViewLeads">
                <label class="form-check-label" for="canViewLeads">
                  <i class="fas fa-eye me-2"></i>Смотреть лидов (без редактирования)
                </label>
              </div>
            </div>
          </div>
        </div>
      }
      } @else if (activeTab() === 'stats') {
        <!-- Статистика -->
        @if (isLoadingStats()) {
          <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Загрузка...</span>
            </div>
            <p class="mt-3 text-muted">Загрузка статистики...</p>
          </div>
        } @else if (stats(); as statsData) {
          <!-- Основные метрики -->
          <div class="stats-grid mb-4">
            <div class="stat-card stat-card--cars">
              <div class="stat-card-icon">
                <i class="fas fa-car"></i>
              </div>
              <div class="stat-card-content">
                <div class="stat-card-value">{{ statsData.carsAdded || 0 }}</div>
                <div class="stat-card-label">Добавлено машин</div>
              </div>
            </div>

            <div class="stat-card stat-card--sold">
              <div class="stat-card-icon">
                <i class="fas fa-check-circle"></i>
              </div>
              <div class="stat-card-content">
                <div class="stat-card-value">{{ statsData.soldCars || 0 }}</div>
                <div class="stat-card-label">Проданных машин</div>
              </div>
            </div>

            <div class="stat-card stat-card--leads">
              <div class="stat-card-icon">
                <i class="fas fa-user-tie"></i>
              </div>
              <div class="stat-card-content">
                <div class="stat-card-value">{{ statsData.leads?.total || 0 }}</div>
                <div class="stat-card-label">Всего лидов</div>
              </div>
            </div>

            <div class="stat-card stat-card--score">
              <div class="stat-card-icon">
                <i class="fas fa-chart-line"></i>
              </div>
              <div class="stat-card-content">
                <div class="stat-card-value">{{ statsData.productivityScore || 0 }}%</div>
                <div class="stat-card-label">Продуктивность</div>
              </div>
            </div>
          </div>

          <!-- Статистика по лидам -->
          @if (statsData.leads) {
            <div class="leads-stats-section mb-4">
              <h5>Статистика по лидам</h5>
              <div class="leads-stats-grid">
                <div class="lead-stat-item lead-stat-item--open">
                  <div class="lead-stat-value">{{ statsData.leads.open || 0 }}</div>
                  <div class="lead-stat-label">Открытых</div>
                </div>
                <div class="lead-stat-item lead-stat-item--progress">
                  <div class="lead-stat-value">{{ statsData.leads.inProgress || 0 }}</div>
                  <div class="lead-stat-label">В работе</div>
                </div>
                <div class="lead-stat-item lead-stat-item--closed">
                  <div class="lead-stat-value">{{ statsData.leads.closed || 0 }}</div>
                  <div class="lead-stat-label">Закрытых</div>
                </div>
                <div class="lead-stat-item lead-stat-item--lost">
                  <div class="lead-stat-value">{{ statsData.leads.lost || 0 }}</div>
                  <div class="lead-stat-label">Потерянных</div>
                </div>
              </div>
            </div>
          }

          <!-- Последние операции -->
          @if (statsData.recentLeads && statsData.recentLeads.length > 0) {
            <div class="recent-leads-section">
              <h5>Последние операции</h5>
              <div class="recent-leads-list">
                @for (lead of statsData.recentLeads; track lead.id) {
                  <div class="recent-lead-item">
                    <div class="lead-info">
                      <div class="lead-name">{{ lead.name }}</div>
                      <div class="lead-meta">
                        <span class="lead-status" [class]="'status-' + lead.status">
                          {{ getStatusLabel(lead.status) }}
                        </span>
                        <span class="lead-priority" [class]="'priority-' + lead.priority">
                          {{ getPriorityLabel(lead.priority) }}
                        </span>
                        @if (lead.score !== undefined) {
                          <span class="lead-score">Score: {{ lead.score }}</span>
                        }
                      </div>
                    </div>
                    <div class="lead-date">{{ formatDate(lead.updatedAt) }}</div>
                  </div>
                }
              </div>
            </div>
          } @else {
            <div class="empty-state">
              <i class="fas fa-inbox"></i>
              <p>Нет операций</p>
            </div>
          }
        } @else {
          <div class="empty-state">
            <i class="fas fa-exclamation-circle"></i>
            <p>Не удалось загрузить статистику</p>
          </div>
        }
      }
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      @if (!isEditing()) {
        <button type="button" class="btn btn-secondary" (click)="closeModal()">Закрыть</button>
        <button type="button" class="btn btn-primary" (click)="toggleEdit()">
          <i class="fas fa-edit me-1"></i>Редактировать
        </button>
      } @else {
        <button type="button" class="btn btn-secondary" (click)="cancelEdit()">Отмена</button>
        <button type="button" class="btn btn-primary" (click)="saveChanges()">
          <i class="fas fa-save me-1"></i>Сохранить
        </button>
      }
    </div>
  </div>
}

