<div class="leads-page">
  <header class="page-header">
    <div class="page-header-content">
      <h1>Управление лидами</h1>
      <p>Создавайте и управляйте лидами от клиентов</p>
    </div>
    <div class="page-header-actions">
      <button class="btn btn-primary" (click)="openCreateModal()">
        <i class="fas fa-plus"></i>
        Создать лид
      </button>
    </div>
  </header>

  <!-- Фильтры -->
  <div class="filters-panel">
    <div class="filter-group">
      <label>Статус:</label>
      <select [(ngModel)]="filterStatus" (change)="applyFilters()">
        <option value="">Все</option>
        <option value="new">Новый</option>
        <option value="in_progress">В работе</option>
        <option value="contacted">Связались</option>
        <option value="closed">Закрыт</option>
        <option value="lost">Потерян</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Источник:</label>
      <select [(ngModel)]="filterSource" (change)="applyFilters()">
        <option value="">Все</option>
        <option value="chat">Чат</option>
        <option value="telegram">Telegram</option>
        <option value="phone">Телефон</option>
        <option value="email">Email</option>
        <option value="other">Другое</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Назначен:</label>
      <select [(ngModel)]="filterAdmin" (change)="applyFilters()">
        <option [value]="null">Все</option>
        <option *ngFor="let admin of admins" [value]="admin.id">{{ admin.email }}</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Поиск:</label>
      <input 
        type="text" 
        [(ngModel)]="searchQuery" 
        (keyup.enter)="applyFilters()"
        placeholder="Имя, email, телефон...">
    </div>
    <button class="btn btn-secondary" (click)="clearFilters()">Сбросить</button>
  </div>

  <!-- Список лидов -->
  <div class="leads-layout">
    <div class="leads-list">
      @if (isLoading()) {
        <div class="loading">Загрузка...</div>
      } @else if (leads().length === 0) {
        <div class="empty-state">
          <i class="fas fa-inbox"></i>
          <p>Лиды не найдены</p>
        </div>
      } @else {
        <div 
          class="lead-item" 
          *ngFor="let lead of leads()"
          [class.active]="selectedLead()?.id === lead.id"
          (click)="selectLead(lead)">
          <div class="lead-header">
            <h3>{{ lead.name }}</h3>
            <span class="status-badge" [class]="getStatusClass(lead.status)">
              {{ getStatusLabel(lead.status) }}
            </span>
          </div>
          <div class="lead-info">
            @if (lead.phone) {
              <span><i class="fas fa-phone"></i> {{ lead.phone }}</span>
            }
            @if (lead.email) {
              <span><i class="fas fa-envelope"></i> {{ lead.email }}</span>
            }
            <span><i class="fas fa-tag"></i> {{ getSourceLabel(lead.source) }}</span>
            @if (lead.hasTelegramContact) {
              <span class="telegram-badge"><i class="fab fa-telegram"></i> Telegram</span>
            }
          </div>
          <div class="lead-meta">
            <span class="priority-badge" [class]="getPriorityClass(lead.priority)">
              {{ getPriorityLabel(lead.priority) }}
            </span>
            <span class="date">{{ formatDate(lead.createdAt) }}</span>
            @if (lead.assignedAdmin) {
              <span class="assigned">{{ lead.assignedAdmin.email }}</span>
            }
          </div>
        </div>
      }
    </div>

    <!-- Детали лида -->
    @if (selectedLead()) {
      <div class="lead-details">
        <div class="lead-details-header">
          <h2>{{ selectedLead()!.name }}</h2>
          <div class="lead-actions">
            <button class="btn btn-sm btn-secondary" (click)="openEditModal(selectedLead()!)">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-danger" (click)="deleteLead(selectedLead()!)">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>

        <div class="lead-details-content">
          <!-- Контактная информация -->
          <div class="info-section">
            <h3>Контактная информация</h3>
            <div class="info-grid">
              @if (selectedLead()!.phone) {
                <div class="info-item">
                  <i class="fas fa-phone"></i>
                  <span>{{ selectedLead()!.phone }}</span>
                </div>
              }
              @if (selectedLead()!.email) {
                <div class="info-item">
                  <i class="fas fa-envelope"></i>
                  <span>{{ selectedLead()!.email }}</span>
                </div>
              }
              <div class="info-item">
                <i class="fas fa-tag"></i>
                <span>{{ getSourceLabel(selectedLead()!.source) }}</span>
              </div>
              @if (selectedLead()!.hasTelegramContact) {
                <div class="info-item">
                  <i class="fab fa-telegram"></i>
                  <span>Telegram: {{ selectedLead()!.telegramUsername || 'Указан' }}</span>
                </div>
              }
            </div>
          </div>

          <!-- Статус и приоритет -->
          <div class="info-section">
            <h3>Статус и приоритет</h3>
            <div class="status-controls">
              <select 
                [(ngModel)]="selectedLead()!.status" 
                (change)="updateLeadStatus(selectedLead()!, selectedLead()!.status)"
                class="status-select">
                <option value="new">Новый</option>
                <option value="in_progress">В работе</option>
                <option value="contacted">Связались</option>
                <option value="closed">Закрыт</option>
                <option value="lost">Потерян</option>
              </select>
              <select 
                [(ngModel)]="selectedLead()!.priority" 
                (change)="updateLeadPriority()"
                class="priority-select">
                <option value="low">Низкий</option>
                <option value="normal">Обычный</option>
                <option value="high">Высокий</option>
                <option value="urgent">Срочный</option>
              </select>
            </div>
          </div>

          <!-- Назначение -->
          <div class="info-section">
            <h3>Назначение</h3>
            <select 
              [ngModel]="selectedLead()!.assignedAdminId" 
              (change)="assignLead(selectedLead()!, +$any($event.target).value || null)"
              class="assign-select">
              <option [value]="null">Не назначен</option>
              <option *ngFor="let admin of admins" [value]="admin.id">{{ admin.email }}</option>
            </select>
          </div>

          <!-- Описание -->
          @if (selectedLead()!.description) {
            <div class="info-section">
              <h3>Описание</h3>
              <p>{{ selectedLead()!.description }}</p>
            </div>
          }

          <!-- Переписка из чата -->
          @if (selectedLead()!.chatSessionId && chatMessages().length > 0) {
            <div class="info-section">
              <h3>Переписка из чата</h3>
              <div class="chat-messages">
                <div 
                  *ngFor="let msg of chatMessages()" 
                  class="chat-message"
                  [class.message-client]="msg.senderType === 'client'"
                  [class.message-admin]="msg.senderType === 'admin'">
                  <div class="message-header">
                    <span class="message-sender">
                      {{ msg.senderType === 'client' ? (msg.clientName || 'Клиент') : 'Администратор' }}
                    </span>
                    <span class="message-time">{{ formatTime(msg.createdAt) }}</span>
                  </div>
                  <div class="message-text">{{ msg.message }}</div>
                </div>
              </div>
            </div>
          }

          <!-- Комментарии -->
          <div class="info-section">
            <h3>Комментарии</h3>
            <div class="comments-list">
              @if (selectedLead()!.comments && selectedLead()!.comments.length > 0) {
                <div 
                  *ngFor="let comment of selectedLead()!.comments" 
                  class="comment-item">
                  <div class="comment-header">
                    <span class="comment-author">{{ comment.admin?.email || 'Админ' }}</span>
                    <span class="comment-date">{{ formatDate(comment.createdAt) }}</span>
                  </div>
                  <div class="comment-text">{{ comment.comment }}</div>
                </div>
              } @else {
                <p class="no-comments">Комментариев пока нет</p>
              }
            </div>
            <div class="comment-form">
              <textarea 
                [(ngModel)]="newComment" 
                placeholder="Добавить комментарий..."
                rows="3"></textarea>
              <button 
                class="btn btn-primary" 
                (click)="addComment()"
                [disabled]="!newComment.trim()">
                Добавить комментарий
              </button>
            </div>
          </div>
        </div>
      </div>
    } @else {
      <div class="no-selection">
        <i class="fas fa-hand-pointer"></i>
        <p>Выберите лид для просмотра деталей</p>
      </div>
    }
  </div>
</div>

<!-- Модальное окно создания/редактирования лида -->
@if (showLeadModal()) {
  <div class="modal-overlay" (click)="showLeadModal.set(false)">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editingLead() ? 'Редактировать лид' : 'Создать лид' }}</h2>
        <button class="modal-close" (click)="showLeadModal.set(false)">×</button>
      </div>
      <div class="modal-body">
        <form>
          <div class="form-group">
            <label>Имя *</label>
            <input type="text" [(ngModel)]="leadForm.name" name="name" required>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" [(ngModel)]="leadForm.email" name="email">
          </div>
          <div class="form-group">
            <label>Телефон</label>
            <input type="tel" [(ngModel)]="leadForm.phone" name="phone">
          </div>
          <div class="form-group">
            <label>Источник</label>
            <select [(ngModel)]="leadForm.source" name="source">
              <option value="chat">Чат</option>
              <option value="telegram">Telegram</option>
              <option value="phone">Телефон</option>
              <option value="email">Email</option>
              <option value="other">Другое</option>
            </select>
          </div>
          <div class="form-group">
            <label>Статус</label>
            <select [(ngModel)]="leadForm.status" name="status">
              <option value="new">Новый</option>
              <option value="in_progress">В работе</option>
              <option value="contacted">Связались</option>
              <option value="closed">Закрыт</option>
              <option value="lost">Потерян</option>
            </select>
          </div>
          <div class="form-group">
            <label>Приоритет</label>
            <select [(ngModel)]="leadForm.priority" name="priority">
              <option value="low">Низкий</option>
              <option value="normal">Обычный</option>
              <option value="high">Высокий</option>
              <option value="urgent">Срочный</option>
            </select>
          </div>
          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" [(ngModel)]="leadForm.hasTelegramContact" name="hasTelegramContact">
              Есть контакт в Telegram
            </label>
          </div>
          @if (leadForm.hasTelegramContact) {
            <div class="form-group">
              <label>Telegram Username</label>
              <input type="text" [(ngModel)]="leadForm.telegramUsername" name="telegramUsername" placeholder="@username">
            </div>
          }
          <div class="form-group">
            <label>Описание</label>
            <textarea [(ngModel)]="leadForm.description" name="description" rows="4"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="showLeadModal.set(false)">Отмена</button>
        <button class="btn btn-primary" (click)="saveLead()">Сохранить</button>
      </div>
    </div>
  </div>
}

