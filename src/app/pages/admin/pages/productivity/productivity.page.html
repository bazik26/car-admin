<section class="productivity-page animate-fade-in">
  <header class="page-header-glass animate-slide-in-top">
    <div class="page-header-text">
      <span class="eyebrow-label">
        <i class="fas fa-chart-line"></i>
        Продуктивность
      </span>
      <h2 class="page-title">Аналитика работы администраторов</h2>
      <p class="page-subtitle">
        Глубокий анализ эффективности команды: активность, ошибки и динамика добавления автомобилей.
      </p>
    </div>
    <div class="page-header-actions">
      <div class="glossy-chip" [class.glossy-chip--loading]="loading">
        <i class="fas fa-bolt"></i>
        <span>Обновление в реальном времени</span>
      </div>
      <button class="btn btn-lion" type="button" (click)="refreshData()" [disabled]="loading">
        <i class="fas fa-sync-alt" [class.fa-spin]="loading"></i>
        <span>{{ loading ? 'Обновляем...' : 'Обновить данные' }}</span>
      </button>
    </div>
  </header>

  @if (loading) {
    <div class="loading-state glass-card animate-fade-in">
      <div class="loading-spinner-large">
        <i class="fas fa-crown fa-spin"></i>
      </div>
      <p class="loading-text">Собираем свежие метрики...</p>
    </div>
  } @else if (error) {
    <div class="alert alert-danger animate-slide-in-top">
      <i class="fas fa-exclamation-triangle me-2"></i>
      {{ error }}
    </div>
  } @else {
    <div class="stat-grid animate-scale-in">
      <article class="stat-card glass-card">
        <div class="stat-icon success">
          <i class="fas fa-trophy"></i>
        </div>
        <div class="stat-info">
          <span class="stat-label">Лучший результат</span>
          <strong class="stat-value">{{ topProductiveAdmins[0]?.carsAdded || 0 }}</strong>
          <small class="stat-meta">Автомобилей добавлено</small>
        </div>
      </article>

      <article class="stat-card glass-card">
        <div class="stat-icon accent">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-info">
          <span class="stat-label">Команда</span>
          <strong class="stat-value">{{ adminStats.length }}</strong>
          <small class="stat-meta">Активных администраторов</small>
        </div>
      </article>

      <article class="stat-card glass-card">
        <div class="stat-icon neutral">
          <i class="fas fa-car"></i>
        </div>
        <div class="stat-info">
          <span class="stat-label">Всего автомобилей</span>
          <strong class="stat-value">{{ getTotalCars() }}</strong>
          <small class="stat-meta">Добавлено за период</small>
        </div>
      </article>

      <article class="stat-card glass-card">
        <div class="stat-icon danger">
          <i class="fas fa-exclamation-circle"></i>
        </div>
        <div class="stat-info">
          <span class="stat-label">Ошибок</span>
          <strong class="stat-value">{{ getTotalErrors() }}</strong>
          <small class="stat-meta">Требует внимания</small>
        </div>
      </article>
    </div>

    <div class="charts-grid">
      <article class="chart-card glass-card animate-slide-in-left">
        <header class="chart-card__header">
          <div class="chart-title">
            <i class="fas fa-chart-bar"></i>
            Топ продуктивных админов
          </div>
        </header>
        <div class="chart-body">
          <canvas
            baseChart
            [data]="productivityChartData"
            [options]="productivityChartOptions"
            type="bar"
          ></canvas>
        </div>
      </article>

      <article class="chart-card glass-card animate-slide-in-right">
        <header class="chart-card__header">
          <div class="chart-title">
            <i class="fas fa-bug"></i>
            Распределение ошибок
          </div>
        </header>
        <div class="chart-body">
          <canvas
            baseChart
            [data]="errorsChartData"
            [options]="errorsChartOptions"
            type="doughnut"
          ></canvas>
        </div>
      </article>

      <article class="chart-card glass-card animate-slide-in-bottom">
        <header class="chart-card__header">
          <div class="chart-title">
            <i class="fas fa-wave-square"></i>
            Динамика добавления автомобилей
          </div>
        </header>
        <div class="chart-body">
          <canvas
            baseChart
            [data]="carsAddedChartData"
            [options]="carsAddedChartOptions"
            type="line"
          ></canvas>
        </div>
      </article>
    </div>

    <div class="ranking-grid">
      <section class="ranking-card glass-card animate-slide-in-left">
        <header class="ranking-header">
          <div class="ranking-title">
            <i class="fas fa-trophy text-warning"></i>
            Топ 5 продуктивных
          </div>
        </header>
        <div class="ranking-list">
          @for (admin of topProductiveAdmins; track admin; let i = $index) {
            <article class="ranking-item" [style.animation-delay]="(i * 0.08) + 's'">
              <div class="ranking-position">
                <span>{{ i + 1 }}</span>
              </div>
              <div class="ranking-info">
                <h4>{{ admin.name }}</h4>
                <ul>
                  <li>
                    <i class="fas fa-car"></i>
                    {{ admin.carsAdded }} авто
                  </li>
                  <li>
                    <i class="fas fa-star"></i>
                    {{ admin.productivityScore }}%
                  </li>
                </ul>
              </div>
              <span class="score-badge" [ngClass]="getProductivityClass(admin.productivityScore)">
                {{ getProductivityLevel(admin.productivityScore) }}
              </span>
            </article>
          }
        </div>
      </section>

      <section class="ranking-card glass-card animate-slide-in-bottom">
        <header class="ranking-header">
          <div class="ranking-title">
            <i class="fas fa-hourglass-end text-info"></i>
            Требуют внимания
          </div>
        </header>
        <div class="ranking-list">
          @for (admin of topUnproductiveAdmins; track admin; let i = $index) {
            <article class="ranking-item warning" [style.animation-delay]="(i * 0.08) + 's'">
              <div class="ranking-position">
                <span>{{ i + 1 }}</span>
              </div>
              <div class="ranking-info">
                <h4>{{ admin.name }}</h4>
                <ul>
                  <li>
                    <i class="fas fa-car"></i>
                    {{ admin.carsAdded }} авто
                  </li>
                  <li>
                    <i class="fas fa-chart-line"></i>
                    {{ admin.productivityScore }}%
                  </li>
                </ul>
              </div>
              <span class="score-badge text-warning">Повышение</span>
            </article>
          }
        </div>
      </section>

      <section class="ranking-card glass-card animate-slide-in-right">
        <header class="ranking-header">
          <div class="ranking-title">
            <i class="fas fa-bug text-danger"></i>
            Ошибки и проблемы
          </div>
        </header>
        <div class="ranking-list">
          @for (admin of topProblematicAdmins; track admin; let i = $index) {
            <article class="ranking-item danger" [style.animation-delay]="(i * 0.08) + 's'">
              <div class="ranking-position">
                <span>{{ i + 1 }}</span>
              </div>
              <div class="ranking-info">
                <h4>{{ admin.name }}</h4>
                <ul>
                  <li>
                    <i class="fas fa-exclamation-circle"></i>
                    {{ admin.errorsCount }} ошибок
                  </li>
                  <li>
                    <i class="fas fa-clock"></i>
                    Последняя активность: {{ admin.lastActivity | date:'dd.MM HH:mm' }}
                  </li>
                </ul>
              </div>
              <span class="score-badge text-danger">Контроль</span>
            </article>
          }
        </div>
      </section>
    </div>
  }
</section>
