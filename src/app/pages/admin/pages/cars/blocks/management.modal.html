@if (form && BRANDS_AND_MODELS) {
  <div class="admin py-3">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <!-- Кнопка закрытия -->
          <div class="d-flex justify-content-end mb-2">
            <button type="button" class="btn-close" (click)="closeModal()" aria-label="Close"></button>
          </div>
          <form [formGroup]="form">
            <!-- Умная кнопка автозаполнения -->
            @if (canAutoFill()) {
              <div class="mb-3 d-flex justify-content-center gap-2 flex-wrap">
                <button
                  class="btn btn-secondary btn-lg"
                  (click)="autoFillForm()"
                  type="button"
                >
                  <i class="fas fa-magic me-2"></i>Автозаполнение для {{ getSelectedCarInfo() }}
                </button>
                <button
                  class="btn btn-info btn-lg"
                  (click)="checkMarketPrice()"
                  type="button"
                  [disabled]="isCheckingPrice"
                >
                  @if (isCheckingPrice) {
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    Проверяем...
                  } @else {
                    <i class="fas fa-chart-line me-2"></i>Проверить цену на рынке
                  }
                </button>
              </div>
            }

            <!-- Панель результатов проверки цены -->
            @if (showPriceResults && priceCheckResult) {
              <div class="card mb-4 border-info">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                  <span>
                    <i class="fas fa-chart-bar me-2"></i>
                    Анализ рыночных цен: {{ getSelectedCarInfo() }}
                  </span>
                  <button type="button" class="btn-close btn-close-white" (click)="closePriceResults()"></button>
                </div>
                <div class="card-body">
                  @if (priceCheckResult.success) {
                    <!-- Статистика цен -->
                    <div class="row mb-4 g-2">
                      <div class="col-6 col-md-3">
                        <div class="price-card border rounded p-2 p-md-3 text-center h-100 bg-light">
                          <div class="price-label text-muted small mb-1">Минимальная</div>
                          <div class="price-value h5 mb-0 text-success text-nowrap">{{ formatPrice(priceCheckResult.minPrice) }}&nbsp;₽</div>
                        </div>
                      </div>
                      <div class="col-6 col-md-3">
                        <div class="price-card border rounded p-2 p-md-3 text-center h-100 bg-light">
                          <div class="price-label text-muted small mb-1">Средняя</div>
                          <div class="price-value h5 mb-0 text-primary text-nowrap">{{ formatPrice(priceCheckResult.averagePrice) }}&nbsp;₽</div>
                        </div>
                      </div>
                      <div class="col-6 col-md-3">
                        <div class="price-card border rounded p-2 p-md-3 text-center h-100 bg-light">
                          <div class="price-label text-muted small mb-1">Медианная</div>
                          <div class="price-value h5 mb-0 text-info text-nowrap">{{ formatPrice(priceCheckResult.medianPrice) }}&nbsp;₽</div>
                        </div>
                      </div>
                      <div class="col-6 col-md-3">
                        <div class="price-card border rounded p-2 p-md-3 text-center h-100 bg-light">
                          <div class="price-label text-muted small mb-1">Максимальная</div>
                          <div class="price-value h5 mb-0 text-danger text-nowrap">{{ formatPrice(priceCheckResult.maxPrice) }}&nbsp;₽</div>
                        </div>
                      </div>
                    </div>

                    <!-- Рекомендуемая цена -->
                    <div class="alert alert-success d-flex justify-content-between align-items-center flex-wrap gap-2">
                      <div>
                        <i class="fas fa-star me-2"></i>
                        <strong>Рекомендуемая цена:</strong> {{ formatPrice(priceCheckResult.suggestedPrice) }} ₽
                        <span class="text-muted small ms-2">(для быстрой продажи)</span>
                      </div>
                      <button type="button" class="btn btn-success btn-sm" (click)="applyPrice(priceCheckResult.suggestedPrice)">
                        <i class="fas fa-check me-1"></i>Применить
                      </button>
                    </div>

                    <!-- Быстрые кнопки для разных цен -->
                    <div class="d-flex flex-wrap gap-2 mb-3">
                      <button type="button" class="btn btn-outline-success btn-sm" (click)="applyPrice(priceCheckResult.minPrice)">
                        Мин: {{ formatPrice(priceCheckResult.minPrice) }} ₽
                      </button>
                      <button type="button" class="btn btn-outline-primary btn-sm" (click)="applyPrice(priceCheckResult.averagePrice)">
                        Средняя: {{ formatPrice(priceCheckResult.averagePrice) }} ₽
                      </button>
                      <button type="button" class="btn btn-outline-info btn-sm" (click)="applyPrice(priceCheckResult.medianPrice)">
                        Медиана: {{ formatPrice(priceCheckResult.medianPrice) }} ₽
                      </button>
                      <button type="button" class="btn btn-outline-danger btn-sm" (click)="applyPrice(priceCheckResult.maxPrice)">
                        Макс: {{ formatPrice(priceCheckResult.maxPrice) }} ₽
                      </button>
                    </div>

                    <!-- Информация о источниках -->
                    <div class="small text-muted mb-3">
                      <i class="fas fa-search me-1"></i>
                      Найдено {{ priceCheckResult.totalFound }} объявлений на: 
                      @for (source of priceCheckResult.sources; track source; let last = $last) {
                        <span class="badge bg-secondary me-1">{{ getSourceName(source) }}</span>
                      }
                    </div>

                    <!-- Список найденных объявлений -->
                    @if (priceCheckResult.listings && priceCheckResult.listings.length > 0) {
                      <details class="mb-2">
                        <summary class="text-primary" style="cursor: pointer;">
                          <i class="fas fa-list me-1"></i>Показать найденные объявления ({{ priceCheckResult.listings.length }})
                        </summary>
                        <div class="mt-2" style="max-height: 300px; overflow-y: auto;">
                          <table class="table table-sm table-hover">
                            <thead class="table-light">
                              <tr>
                                <th>Название</th>
                                <th>Год</th>
                                <th>Пробег</th>
                                <th>Цена</th>
                                <th>Источник</th>
                              </tr>
                            </thead>
                            <tbody>
                              @for (listing of priceCheckResult.listings; track listing.link + listing.price) {
                                <tr>
                                  <td>
                                    @if (listing.link) {
                                      <a [href]="listing.link" target="_blank" class="text-decoration-none">
                                        {{ listing.title }}
                                        <i class="fas fa-external-link-alt ms-1 small"></i>
                                      </a>
                                    } @else {
                                      {{ listing.title }}
                                    }
                                  </td>
                                  <td>{{ listing.year }}</td>
                                  <td>{{ listing.mileage ? formatPrice(listing.mileage) + ' км' : '—' }}</td>
                                  <td class="fw-bold">{{ formatPrice(listing.price) }} ₽</td>
                                  <td><span class="badge bg-secondary">{{ getSourceName(listing.source) }}</span></td>
                                </tr>
                              }
                            </tbody>
                          </table>
                        </div>
                      </details>
                    }
                  } @else {
                    <!-- Ошибка или нет результатов -->
                    <div class="alert alert-warning mb-3">
                      <i class="fas fa-exclamation-triangle me-2"></i>
                      {{ priceCheckResult.error || 'Не удалось найти объявления' }}
                    </div>
                    @if (priceCheckResult.suggestedPrice) {
                      <div class="alert alert-info d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                          <i class="fas fa-calculator me-2"></i>
                          <strong>Оценочная цена:</strong> {{ formatPrice(priceCheckResult.suggestedPrice) }} ₽
                          <span class="text-muted small ms-2">(на основе алгоритма)</span>
                        </div>
                        <button type="button" class="btn btn-info btn-sm" (click)="applyPrice(priceCheckResult.suggestedPrice)">
                          <i class="fas fa-check me-1"></i>Применить
                        </button>
                      </div>
                    }
                  }
                </div>
              </div>
            }

            <div class="form-control">
              <div class="form-group required-field">
                <label class="form-label">Марка</label>
                <ng-select
                  [items]="brands"
                  bindLabel="title"
                  bindValue="title"
                  placeholder="Выберите марку"
                  [searchable]="true"
                  formControlName="brand"
                >
                </ng-select>
              </div>

              <div class="mt-3 form-group required-field">
                <label class="form-label">Модель</label>

                <ng-select
                  [items]="models"
                  bindLabel="title"
                  bindValue="title"
                  placeholder="Выберите модель"
                  [searchable]="true"
                  formControlName="model"
                >
                </ng-select>
              </div>

              <div class="mt-3 form-group required-field">
                <label class="form-label">Год</label>

                <ng-select
                  [items]="years"
                  placeholder="Выберите год"
                  formControlName="year"
                >
                </ng-select>
              </div>

              <div class="mt-3 form-group required-field">
                <label class="form-label">Пробег</label>

                <input
                  class="form-control"
                  type="number"
                  placeholder="Введите пробег"
                  formControlName="mileage"
                />
              </div>

              <div class="mt-3 form-group">
                <label class="form-label">VIN</label>

                <input
                  class="form-control"
                  placeholder="Введите VIN"
                  formControlName="vin"
                />
              </div>

              <div class="mt-3 form-group required-field">
                <label class="form-label">Коробка передач</label>

                <ng-select
                  [items]="gearboxes"
                  placeholder="Выберете коробку передач"
                  formControlName="gearbox"
                >
                </ng-select>
              </div>

              <div class="mt-3 form-group required-field">
                <label class="form-label">Топливо</label>

                <ng-select
                  [items]="fuels"
                  placeholder="Выберете тип топлива"
                  formControlName="fuel"
                >
                </ng-select>
              </div>

              <div class="mt-3 form-group required-field">
                <label class="form-label">Мощность двигателя</label>

                <input
                  class="form-control"
                  placeholder="Введите мощность двигателя"
                  formControlName="powerValue"
                />
              </div>

              <div class="mt-3 form-group required-field">
                <label class="form-label">Тип мощности двигателя</label>

                <ng-select
                  [items]="powerTypes"
                  placeholder="Выберете тип мощности двигателя"
                  formControlName="powerType"
                >
                </ng-select>
              </div>

              <div class="mt-3 form-group required-field">
                <label class="form-label">Объем двигателя</label>

                <input
                  class="form-control"
                  type="number"
                  placeholder="Введите объем двигателя"
                  formControlName="engine"
                />
              </div>

              <div class="mt-3 form-group required-field">
                <label class="form-label">Привод</label>

                <ng-select
                  [items]="drives"
                  placeholder="Выберете привод"
                  formControlName="drive"
                >
                </ng-select>
              </div>

              <div class="mt-3 form-group required-field">
                <label class="form-label">Цена</label>

                <input
                  class="form-control"
                  type="number"
                  placeholder="Выберете цену"
                  formControlName="price"
                />
              </div>

<!--              <div class="mt-3 form-group">-->
<!--                <label class="form-label">Описание</label>-->
<!--                <textarea-->
<!--                  class="form-control"-->
<!--                  rows="4"-->
<!--                  placeholder="Введите описание автомобиля"-->
<!--                  formControlName="description"-->
<!--                ></textarea>-->
<!--              </div>-->

              <div class="mt-3 form-group required-field" formArrayName="files">
                <label class="form-label">Изображения (минимум 8)</label>
                
                <!-- Пакетная загрузка изображений -->
                <div class="mb-3">
                  <input
                    type="file"
                    class="form-control"
                    accept="image/*"
                    multiple
                    (change)="onMultipleFilesSelected($event)"
                    id="bulkUpload"
                  />
                  <small class="form-text text-muted">
                    Выберите несколько изображений сразу (Ctrl/Cmd + клик)
                  </small>
                </div>

                <div class="d-flex flex-wrap gap-3 mt-2 justify-content-around">
                  @for (
                    control of files.controls;
                    track control;
                    let i = $index
                  ) {
                    <div
                      class="file-upload-area position-relative d-flex align-items-center justify-content-center"
                      style="width: 150px; height: 150px"
                    >
                      @if (!previews[i]) {
                        <input
                          type="file"
                          class="form-control position-absolute w-100 h-100 opacity-0"
                          accept="image/*"
                          (change)="onFileSelected($event, i)"
                        />
                        <span class="upload-text">Загрузить</span>
                      }

                      @if (previews[i]) {
                        <img
                          [src]="previews[i]!"
                          alt="preview"
                          class="w-100 h-100 rounded"
                          style="object-fit: cover"
                        />
                        <button
                          type="button"
                          class="remove-btn position-absolute top-0 end-0 m-1"
                          (click)="removeFile(i, control.value)"
                          aria-label="Удалить файл"
                        >
                          ✕
                        </button>
                      }
                    </div>
                  }
                </div>
              </div>

              @for (group of options; track group) {
                <div class="form-group mt-3">
                  <label>{{ group.title }}</label>

                  <ng-select
                    [items]="group.values"
                    formControlName="{{ group.controlName }}"
                    placeholder="Выберите"
                  >
                  </ng-select>
                </div>
              }

              <accordion class="mt-3">
                <accordion-group heading="Салон и комфорт" [isOpen]="true">
                  @for (item of group1; track item) {
                    <div class="mb-2 form-check">
                      <label class="form-check-label">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          [value]="item"
                          [checked]="
                            (form.get('group1')?.value || []).includes(item)
                          "
                          (change)="onCheckboxChange($event, 'group1')"
                        />
                        {{ item }}
                      </label>
                    </div>
                  }
                </accordion-group>

                <accordion-group
                  class="mt-3"
                  heading="Система помощи при парковке"
                >
                  @for (item of group2; track item) {
                    <div class="mb-2 form-check">
                      <label class="form-check-label">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          [value]="item"
                          [checked]="
                            (form.get('group2')?.value || []).includes(item)
                          "
                          (change)="onCheckboxChange($event, 'group2')"
                        />
                        {{ item }}
                      </label>
                    </div>
                  }
                </accordion-group>

                <accordion-group class="mt-3" heading="Мультимедиа">
                  @for (item of group3; track item) {
                    <div class="mb-2 form-check">
                      <label class="form-check-label">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          [value]="item"
                          [checked]="
                            (form.get('group3')?.value || []).includes(item)
                          "
                          (change)="onCheckboxChange($event, 'group3')"
                        />
                        {{ item }}
                      </label>
                    </div>
                  }
                </accordion-group>

                <accordion-group class="mt-3" heading="Оптика">
                  @for (item of group4; track item) {
                    <div class="mb-2 form-check">
                      <label class="form-check-label">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          [value]="item"
                          [checked]="
                            (form.get('group4')?.value || []).includes(item)
                          "
                          (change)="onCheckboxChange($event, 'group4')"
                        />
                        {{ item }}
                      </label>
                    </div>
                  }
                </accordion-group>

                <accordion-group class="mt-3" heading="Безопасность">
                  @for (item of group5; track item) {
                    <div class="mb-2 form-check">
                      <label class="form-check-label">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          [value]="item"
                          [checked]="
                            (form.get('group5')?.value || []).includes(item)
                          "
                          (change)="onCheckboxChange($event, 'group5')"
                        />
                        {{ item }}
                      </label>
                    </div>
                  }
                </accordion-group>

                <accordion-group class="mt-3" heading="Состояние">
                  @for (item of group6; track item) {
                    <div class="mb-2 form-check">
                      <label class="form-check-label">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          [value]="item"
                          [checked]="
                            (form.get('group6')?.value || []).includes(item)
                          "
                          (change)="onCheckboxChange($event, 'group6')"
                        />
                        {{ item }}
                      </label>
                    </div>
                  }
                </accordion-group>

                <accordion-group class="mt-3" heading="Кузов">
                  @for (item of group7; track item) {
                    <div class="mb-2 form-check">
                      <label class="form-check-label">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          [value]="item"
                          [checked]="
                            (form.get('group7')?.value || []).includes(item)
                          "
                          (change)="onCheckboxChange($event, 'group7')"
                        />
                        {{ item }}
                      </label>
                    </div>
                  }
                </accordion-group>

                <accordion-group class="mt-3" heading="Подушки безопасности">
                  @for (item of group8; track item) {
                    <div class="mb-2 form-check">
                      <label class="form-check-label">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          [value]="item"
                          [checked]="
                            (form.get('group8')?.value || []).includes(item)
                          "
                          (change)="onCheckboxChange($event, 'group8')"
                        />
                        {{ item }}
                      </label>
                    </div>
                  }
                </accordion-group>

                <accordion-group
                  class="mt-3"
                  heading="Дополнительное оборудование"
                >
                  @for (item of group9; track item) {
                    <div class="mb-2 form-check">
                      <label class="form-check-label">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          [value]="item"
                          [checked]="
                            (form.get('group9')?.value || []).includes(item)
                          "
                          (change)="onCheckboxChange($event, 'group9')"
                        />
                        {{ item }}
                      </label>
                    </div>
                  }
                </accordion-group>
              </accordion>
            </div>

            <div class="mt-3 d-flex justify-content-center gap-3">
              <button
                class="btn btn-secondary btn-lg"
                (click)="closeModal()"
                type="button"
              >
                Отменить
              </button>
              <button
                class="btn btn-primary btn-lg"
                (click)="onSubmit()"
                [disabled]="form.invalid || previews.length < 8 || isSubmitting"
                [title]="previews.length < 8 ? 'Загрузите минимум 8 изображений' : ''"
              >
                @if (isSubmitting) {
                  <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                  Сохранение...
                } @else {
                  {{ car ? "Обновить" : "Добавить" }} ({{ previews.length }}/8)
                }
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
}
