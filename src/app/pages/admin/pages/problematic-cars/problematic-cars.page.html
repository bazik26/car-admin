@if (admin && admin.isSuper) {
  <section class="problematic-page animate-fade-in">
    <header class="page-header-glass animate-slide-in-top">
      <div class="page-header-text">
        <span class="eyebrow-label">
          <i class="fas fa-exclamation-circle"></i>
          Контроль качества
        </span>
        <h2 class="page-title">Проблемные автомобили</h2>
        <p class="page-subtitle">
          Проверяйте заполненность карточек, отслеживайте критичные ошибки и исправляйте их до публикации.
        </p>
      </div>
      <div class="page-header-actions">
        <div class="refresh-chip" [class.refresh-chip--active]="loading">
          <i class="fas fa-sync-alt" [class.fa-spin]="loading"></i>
          <span>Обновлено {{ loadTimestamp ? (loadTimestamp | date:'HH:mm') : '—' }}</span>
        </div>
        <button
          class="btn btn-lion"
          type="button"
          (click)="loadProblematicCars()"
          [disabled]="loading"
        >
          <i class="fas fa-sync-alt"></i>
          <span>Обновить</span>
        </button>
      </div>
    </header>

    <div class="metrics-grid animate-scale-in">
      <div class="metric-card glass-card">
        <div class="metric-icon danger">
          <i class="fas fa-car-crash"></i>
        </div>
        <div class="metric-content">
          <span class="metric-label">Всего авто</span>
          <strong class="metric-value">{{ problematicCars.length }}</strong>
        </div>
      </div>
      <div class="metric-card glass-card">
        <div class="metric-icon warning">
          <i class="fas fa-exclamation"></i>
        </div>
        <div class="metric-content">
          <span class="metric-label">Всего проблем</span>
          <strong class="metric-value">{{ getTotalProblems() }}</strong>
        </div>
      </div>
      <div class="metric-card glass-card">
        <div class="metric-icon accent">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="metric-content">
          <span class="metric-label">Среднее проблем</span>
          <strong class="metric-value">{{ getAverageProblems() }}</strong>
        </div>
      </div>
      <div class="metric-card glass-card">
        <div class="metric-icon muted">
          <i class="fas fa-image-slash"></i>
        </div>
        <div class="metric-content">
          <span class="metric-label">Без фото</span>
          <strong class="metric-value">{{ carsWithoutImagesCount }}</strong>
        </div>
      </div>
    </div>

    @if (loading) {
      <div class="loading-state glass-card animate-fade-in">
        <div class="loading-spinner-large">
          <i class="fas fa-crown fa-spin"></i>
        </div>
        <p class="loading-text">Анализируем автомобили...</p>
      </div>
    } @else if (problematicCars.length === 0) {
      <div class="data-empty animate-fade-in">
        <i class="fas fa-check-circle"></i>
        <h3>Отлично! Критичных проблем не найдено</h3>
        <p>Все карточки заполнены корректно. Продолжайте в том же духе.</p>
      </div>
    } @else {
      <div class="problems-grid">
        @for (car of problematicCars; track car.id; let i = $index) {
          <article
            class="problem-card glass-card animate-slide-in-bottom"
            [style.animation-delay]="(i * 0.05) + 's'"
          >
            <div class="problem-card__header">
              <div class="problem-card__title">
                <h3>
                  {{ car.brand }} {{ car.model }}
                  <span class="car-year">{{ car.year }}</span>
                </h3>
                <div class="problem-count">
                  <i class="fas fa-bolt"></i>
                  {{ car.problems.length }} проблем
                </div>
              </div>
              <span
                class="status-pill"
                [ngClass]="{
                  danger: car.deletedAt,
                  warning: car.isSold && !car.deletedAt,
                  success: !car.isSold && !car.deletedAt
                }"
              >
                <i
                  class="fas"
                  [ngClass]="{
                    'fa-ban': car.deletedAt,
                    'fa-award': car.isSold && !car.deletedAt,
                    'fa-check-circle': !car.isSold && !car.deletedAt
                  }"
                ></i>
                @if (car.deletedAt) {
                  Удалена
                } @else if (car.isSold) {
                  Продана
                } @else {
                  Активна
                }
              </span>
            </div>

            <div class="problem-card__body">
              <div class="problem-card__media">
                @if (car.files?.length > 0) {
                  <img
                    [ngSrc]="appService.getFileUrl(car.files[0])"
                    alt="{{ car.brand }} {{ car.model }}"
                    height="140"
                    width="220"
                    [priority]="i < 8"
                  />
                } @else {
                  <div class="media-placeholder">
                    <i class="fas fa-image"></i>
                    <span>Нет фото</span>
                  </div>
                }
              </div>
              <div class="problem-card__meta">
                <div class="meta-row">
                  <span>Пробег</span>
                  <strong>{{ car.mileage ? (car.mileage | number) + ' км' : '—' }}</strong>
                </div>
                <div class="meta-row">
                  <span>Цена</span>
                  <strong>{{ car.price ? (car.price | number:'1.0-0') + ' ₸' : '—' }}</strong>
                </div>
                <div class="meta-row">
                  <span>Двигатель</span>
                  <strong>
                    @if (car.engine && car.powerValue) {
                      {{ car.engine }} л • {{ car.powerValue }} л.с.
                    } @else {
                      —
                    }
                  </strong>
                </div>
                <div class="meta-row">
                  <span>Автор</span>
                  <strong>{{ car.admin?.email || 'Не указан' }}</strong>
                </div>
              </div>
            </div>

            <div class="problem-card__issues">
              @for (problem of car.problems; track problem) {
                <span class="problem-chip">
                  <i class="fas fa-exclamation-circle"></i>
                  {{ problem }}
                </span>
              }
            </div>

            <div class="problem-card__actions">
              <button
                type="button"
                class="btn btn-ghost btn-action accent"
                (click)="openModal(car)"
              >
                <i class="fas fa-edit"></i>
                <span>Редактировать</span>
              </button>

              <button
                type="button"
                class="btn btn-ghost btn-action danger"
                (click)="deleteCar(car)"
              >
                <i class="fas fa-trash"></i>
                <span>Удалить</span>
              </button>
            </div>
          </article>
        }
      </div>
    }
  </section>
} @else {
  <section class="problematic-page animate-fade-in">
    <div class="data-empty animate-fade-in">
      <i class="fas fa-lock"></i>
      <h3>Доступ ограничен</h3>
      <p>Раздел доступен только супер администраторам.</p>
    </div>
  </section>
}
