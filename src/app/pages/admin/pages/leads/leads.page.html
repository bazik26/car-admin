<div class="leads-page">
  <header class="page-header">
    <div class="page-header-content">
      <h1>Управление лидами</h1>
      <p>Создавайте и управляйте лидами от клиентов</p>
    </div>
    <div class="page-header-actions">
      <button class="btn btn-primary" (click)="openCreateModal()">
        <i class="fas fa-plus"></i>
        Создать лид
      </button>
    </div>
  </header>

  <!-- Фильтры -->
  <div class="filters-panel">
    <div class="filter-group">
      <label>Статус:</label>
      <select [(ngModel)]="filterStatus" (change)="applyFilters()">
        <option value="">Все</option>
        <option value="new">Новый</option>
        <option value="in_progress">В работе</option>
        <option value="contacted">Связались</option>
        <option value="closed">Закрыт</option>
        <option value="lost">Потерян</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Источник:</label>
      <select [(ngModel)]="filterSource" (change)="applyFilters()">
        <option value="">Все</option>
        <option value="chat">Чат</option>
        <option value="telegram">Telegram</option>
        <option value="phone">Телефон</option>
        <option value="email">Email</option>
        <option value="other">Другое</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Назначен:</label>
      <select [(ngModel)]="filterAdmin" (change)="applyFilters()">
        <option [value]="null">Все</option>
        <option *ngFor="let admin of admins" [value]="admin.id">{{ admin.email }}</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Поиск:</label>
      <input 
        type="text" 
        [(ngModel)]="searchQuery" 
        (keyup.enter)="applyFilters()"
        placeholder="Имя, email, телефон...">
    </div>
    <button class="btn btn-secondary" (click)="clearFilters()">Сбросить</button>
  </div>

  <!-- Таблица лидов -->
  @if (isLoading()) {
    <div class="loading">Загрузка...</div>
  } @else if (leads().length === 0) {
    <div class="empty-state">
      <i class="fas fa-inbox"></i>
      <p>Лиды не найдены</p>
    </div>
  } @else {
    <div class="table-card">
      <table class="table table-hover align-middle data-table">
        <thead>
          <tr>
            <th>Имя</th>
            <th>Контакты</th>
            <th>Источник</th>
            <th>Статус</th>
            <th>Приоритет</th>
            <th>Score</th>
            <th>Назначен</th>
            <th>Дата создания</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody>
          @for (lead of leads(); track lead.id) {
            <tr 
              class="lead-row" 
              (click)="openDetailsModal(lead, $event)"
              [attr.data-lead-id]="lead.id"
              style="cursor: pointer;">
              <td data-label="Имя">
                <div class="lead-name-cell">
                  <strong>{{ lead.name }}</strong>
                  @if (lead.hasTelegramContact) {
                    <span class="telegram-indicator" title="Есть Telegram контакт">
                      <i class="fab fa-telegram"></i>
                    </span>
                  }
                  @if (lead.tags && lead.tags.length > 0) {
                    <div class="tags-preview">
                      @for (tag of lead.tags.slice(0, 2); track tag.id) {
                        <span class="tag-badge" [style.background-color]="tag.color">{{ tag.name }}</span>
                      }
                      @if (lead.tags.length > 2) {
                        <span class="tag-more">+{{ lead.tags.length - 2 }}</span>
                      }
                    </div>
                  }
                </div>
              </td>
              <td data-label="Контакты">
                <div class="contacts-cell">
                  @if (lead.phone) {
                    <div class="contact-item">
                      <i class="fas fa-phone"></i>
                      <span>{{ lead.phone }}</span>
                    </div>
                  }
                  @if (lead.email) {
                    <div class="contact-item">
                      <i class="fas fa-envelope"></i>
                      <span>{{ lead.email }}</span>
                    </div>
                  }
                </div>
              </td>
              <td data-label="Источник">
                <span class="source-badge">
                  <i class="fas" 
                    [ngClass]="{
                      'fa-comments': lead.source === 'chat',
                      'fa-paper-plane': lead.source === 'telegram',
                      'fa-phone': lead.source === 'phone',
                      'fa-envelope': lead.source === 'email',
                      'fa-question': lead.source === 'other'
                    }"></i>
                  {{ getSourceLabel(lead.source) }}
                </span>
              </td>
              <td data-label="Статус">
                <span class="status-badge" [class]="getStatusClass(lead.status)">
                  {{ getStatusLabel(lead.status) }}
                </span>
              </td>
              <td data-label="Приоритет">
                <span class="priority-badge" [class]="getPriorityClass(lead.priority)">
                  {{ getPriorityLabel(lead.priority) }}
                </span>
              </td>
              <td data-label="Score">
                <div class="score-cell">
                  <span class="score-value" [class]="getScoreClass(lead.score || 0)">
                    {{ lead.score || 0 }}
                  </span>
                </div>
              </td>
              <td data-label="Назначен">
                @if (lead.assignedAdmin) {
                  <span class="assigned-admin">
                    <i class="fas fa-user"></i>
                    {{ lead.assignedAdmin.email }}
                  </span>
                } @else {
                  <span class="not-assigned">Не назначен</span>
                }
              </td>
              <td data-label="Дата создания">
                <span class="date-cell">{{ formatDate(lead.createdAt) }}</span>
              </td>
              <td data-label="Действия" (click)="$event.stopPropagation()">
                <div class="action-menu">
                  <button 
                    class="btn btn-sm btn-secondary" 
                    (click)="openEditModal(lead)"
                    title="Редактировать">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button 
                    class="btn btn-sm btn-danger" 
                    (click)="deleteLead(lead)"
                    title="Удалить">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>

<!-- Модальное окно с деталями лида - вне контейнера leads-page -->
@if (showDetailsModal() && selectedLead()) {
  @if (selectedLead(); as lead) {
    <div class="modal-overlay" (click)="closeDetailsModal()">
      <div class="modal-content modal-large modal-fullscreen" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-header-content">
          <h2>{{ lead.name }}</h2>
          @if (lead.score !== undefined) {
            <span class="lead-score" [class]="getScoreClass(lead.score)">
              Score: {{ lead.score }}
            </span>
          }
          @if (lead.convertedToClient) {
            <span class="converted-badge">
              <i class="fas fa-check-circle"></i> Конвертирован в клиента
            </span>
          }
        </div>
        <button class="modal-close" (click)="closeDetailsModal()">×</button>
      </div>
      
      <!-- Табы -->
      <div class="modal-tabs">
        <button 
          class="tab-btn" 
          [class.active]="activeTab() === 'info'"
          (click)="activeTab.set('info')">
          <i class="fas fa-info-circle"></i> Информация
        </button>
        <button 
          class="tab-btn" 
          [class.active]="activeTab() === 'tasks'"
          (click)="activeTab.set('tasks')">
          <i class="fas fa-tasks"></i> Задачи
          @if (leadTasks().length > 0) {
            <span class="badge">{{ leadTasks().length }}</span>
          }
        </button>
        <button 
          class="tab-btn" 
          [class.active]="activeTab() === 'tags'"
          (click)="activeTab.set('tags')">
          <i class="fas fa-tags"></i> Теги
        </button>
        <button 
          class="tab-btn" 
          [class.active]="activeTab() === 'attachments'"
          (click)="activeTab.set('attachments')">
          <i class="fas fa-paperclip"></i> Файлы
          @if (leadAttachments().length > 0) {
            <span class="badge">{{ leadAttachments().length }}</span>
          }
        </button>
        <button 
          class="tab-btn" 
          [class.active]="activeTab() === 'meetings'"
          (click)="activeTab.set('meetings')">
          <i class="fas fa-calendar"></i> Встречи
          @if (leadMeetings().length > 0) {
            <span class="badge">{{ leadMeetings().length }}</span>
          }
        </button>
        <button 
          class="tab-btn" 
          [class.active]="activeTab() === 'activity'"
          (click)="activeTab.set('activity')">
          <i class="fas fa-history"></i> История
        </button>
      </div>
      
      <div class="modal-body">
        <!-- Вкладка: Информация -->
        @if (activeTab() === 'info') {
          <!-- Контактная информация -->
          <div class="info-section">
            <h3>Контактная информация</h3>
            <div class="info-grid">
              @if (lead.phone) {
                <div class="info-item">
                  <i class="fas fa-phone"></i>
                  <span>{{ lead.phone }}</span>
                </div>
              }
              @if (lead.email) {
                <div class="info-item">
                  <i class="fas fa-envelope"></i>
                  <span>{{ lead.email }}</span>
                </div>
              }
              <div class="info-item">
                <i class="fas fa-tag"></i>
                <span>{{ getSourceLabel(lead.source) }}</span>
              </div>
              @if (lead.hasTelegramContact) {
                <div class="info-item">
                  <i class="fab fa-telegram"></i>
                  <span>Telegram: {{ lead.telegramUsername || 'Указан' }}</span>
                </div>
              }
            </div>
          </div>

          <!-- Статус и приоритет -->
          <div class="info-section">
            <h3>Статус и приоритет</h3>
            <div class="status-controls">
              <select 
                [(ngModel)]="lead.status" 
                (change)="updateLeadStatus(lead, lead.status)"
                class="status-select">
                <option value="new">Новый</option>
                <option value="in_progress">В работе</option>
                <option value="contacted">Связались</option>
                <option value="closed">Закрыт</option>
                <option value="lost">Потерян</option>
              </select>
              <select 
                [(ngModel)]="lead.priority" 
                (change)="updateLeadPriority()"
                class="priority-select">
                <option value="low">Низкий</option>
                <option value="normal">Обычный</option>
                <option value="high">Высокий</option>
                <option value="urgent">Срочный</option>
              </select>
            </div>
          </div>

          <!-- Назначение -->
          <div class="info-section">
            <h3>Назначение</h3>
            <select 
              [ngModel]="lead.assignedAdminId" 
              (change)="assignLead(lead, +$any($event.target).value || null)"
              class="assign-select">
              <option [value]="null">Не назначен</option>
              <option *ngFor="let admin of admins" [value]="admin.id">{{ admin.email }}</option>
            </select>
          </div>

          <!-- Описание -->
          <div class="info-section">
            <h3>Описание</h3>
            @if (lead.description) {
              <p>{{ lead.description }}</p>
            } @else {
              <p class="text-muted" style="color: #9ca3af; font-style: italic;">Описание не указано</p>
            }
          </div>

          <!-- Переписка из чата -->
          @if (lead.chatSessionId && chatMessages().length > 0) {
            <div class="info-section">
              <h3>Переписка из чата</h3>
              <div class="chat-messages">
                @for (msg of chatMessages(); track msg.id || msg.createdAt) {
                  <div class="chat-message"
                    [class.message-client]="msg.senderType === 'client'"
                    [class.message-admin]="msg.senderType === 'admin'">
                    <div class="message-header">
                      <span class="message-sender">
                        {{ msg.senderType === 'client' ? (msg.clientName || 'Клиент') : 'Администратор' }}
                      </span>
                      <span class="message-time">{{ formatTime(msg.createdAt) }}</span>
                    </div>
                    <div class="message-text">{{ msg.message }}</div>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Комментарии -->
          <div class="info-section">
            <h3>Комментарии</h3>
            <div class="comments-list">
              @if (lead.comments && lead.comments.length > 0) {
                @for (comment of lead.comments; track comment.id) {
                  <div class="comment-item">
                    <div class="comment-header">
                      <span class="comment-author">{{ comment.admin?.email || 'Админ' }}</span>
                      <span class="comment-date">{{ formatDate(comment.createdAt) }}</span>
                    </div>
                    <div class="comment-text">{{ comment.comment }}</div>
                  </div>
                }
              } @else {
                <p class="no-comments">Комментариев пока нет</p>
              }
            </div>
            <div class="comment-form">
              <textarea 
                [(ngModel)]="newComment" 
                placeholder="Добавить комментарий..."
                rows="3"></textarea>
              <button 
                class="btn btn-primary" 
                (click)="addComment()"
                [disabled]="!newComment.trim()">
                Добавить комментарий
              </button>
            </div>
          </div>
        }

        <!-- Вкладка: Задачи -->
        @if (activeTab() === 'tasks') {
          <div class="info-section">
            <div class="section-header">
              <h3>Задачи</h3>
              <button class="btn btn-sm btn-primary" (click)="showTaskForm.set(!showTaskForm())">
                <i class="fas fa-plus"></i> Добавить задачу
              </button>
            </div>

            @if (showTaskForm()) {
              <div class="task-form">
                <input 
                  type="text" 
                  [(ngModel)]="newTask.title" 
                  placeholder="Название задачи"
                  class="form-control">
                <textarea 
                  [(ngModel)]="newTask.description" 
                  placeholder="Описание (необязательно)"
                  rows="2"
                  class="form-control"></textarea>
                <input 
                  type="datetime-local" 
                  [(ngModel)]="newTask.dueDate"
                  class="form-control">
                <div class="form-actions">
                  <button class="btn btn-primary" (click)="createTask()">Создать</button>
                  <button class="btn btn-secondary" (click)="showTaskForm.set(false)">Отмена</button>
                </div>
              </div>
            }

            <div class="tasks-list">
              @if (leadTasks().length > 0) {
                @for (task of leadTasks(); track task.id) {
                  <div class="task-item" [class.completed]="task.completed">
                    <div class="task-checkbox">
                      <input 
                        type="checkbox" 
                        [checked]="task.completed"
                        (change)="toggleTask(task)">
                    </div>
                    <div class="task-content">
                      <div class="task-title">{{ task.title }}</div>
                      @if (task.description) {
                        <div class="task-description">{{ task.description }}</div>
                      }
                      <div class="task-meta">
                        @if (task.dueDate) {
                          <span class="task-due" [class.overdue]="isOverdue(task.dueDate)">
                            <i class="fas fa-clock"></i> 
                            {{ formatDate(task.dueDate) }}
                          </span>
                        }
                        <span class="task-admin">{{ task.admin?.email || 'Админ' }}</span>
                      </div>
                    </div>
                    <button class="btn btn-sm btn-danger" (click)="deleteTask(task.id)">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                }
              } @else {
                <p class="empty-state">Задач пока нет</p>
              }
            </div>
          </div>
        }

        <!-- Вкладка: Теги -->
        @if (activeTab() === 'tags') {
          <div class="info-section">
            <div class="section-header">
              <h3>Теги</h3>
              <button class="btn btn-sm btn-primary" (click)="showTagForm.set(!showTagForm())">
                <i class="fas fa-plus"></i> Создать тег
              </button>
            </div>

            @if (showTagForm()) {
              <div class="tag-form">
                <input 
                  type="text" 
                  [(ngModel)]="newTag.name" 
                  placeholder="Название тега"
                  class="form-control">
                <input 
                  type="color" 
                  [(ngModel)]="newTag.color"
                  class="form-control color-input">
                <div class="form-actions">
                  <button class="btn btn-primary" (click)="createTag()">Создать</button>
                  <button class="btn btn-secondary" (click)="showTagForm.set(false)">Отмена</button>
                </div>
              </div>
            }

            <div class="tags-list">
              <h4>Доступные теги</h4>
              @if (allTags().length > 0) {
                <div class="tags-grid">
                  @for (tag of allTags(); track tag.id) {
                    <div class="tag-item" 
                      [class.active]="isTagAssigned(tag.id)"
                      (click)="toggleTag(tag.id)">
                      <span class="tag-badge" [style.background-color]="tag.color">{{ tag.name }}</span>
                    </div>
                  }
                </div>
              } @else {
                <p class="empty-state">Тегов пока нет</p>
              }
            </div>
          </div>
        }

        <!-- Вкладка: Файлы -->
        @if (activeTab() === 'attachments') {
          <div class="info-section">
            <div class="section-header">
              <h3>Файлы и вложения</h3>
              <label class="btn btn-sm btn-primary">
                <i class="fas fa-upload"></i> Загрузить файл
                <input 
                  type="file" 
                  (change)="onFileSelected($event)"
                  style="display: none;">
              </label>
            </div>

            <div class="attachments-list">
              @if (leadAttachments().length > 0) {
                @for (attachment of leadAttachments(); track attachment.id) {
                  <div class="attachment-item">
                    <i class="fas fa-file"></i>
                    <div class="attachment-info">
                      <div class="attachment-name">{{ attachment.fileName }}</div>
                      <div class="attachment-meta">
                        @if (attachment.fileSize) {
                          <span>{{ formatFileSize(attachment.fileSize) }}</span>
                        }
                        <span>{{ formatDate(attachment.createdAt) }}</span>
                        @if (attachment.admin) {
                          <span>{{ attachment.admin.email }}</span>
                        }
                      </div>
                    </div>
                    <a 
                      [href]="appService.API_URL + attachment.filePath" 
                      target="_blank"
                      class="btn btn-sm btn-secondary">
                      <i class="fas fa-download"></i>
                    </a>
                    <button class="btn btn-sm btn-danger" (click)="deleteAttachment(attachment.id)">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                }
              } @else {
                <p class="empty-state">Файлов пока нет</p>
              }
            </div>
          </div>
        }

        <!-- Вкладка: Встречи -->
        @if (activeTab() === 'meetings') {
          <div class="info-section">
            <div class="section-header">
              <h3>Встречи и календарь</h3>
              <button class="btn btn-sm btn-primary" (click)="showMeetingForm.set(!showMeetingForm())">
                <i class="fas fa-plus"></i> Создать встречу
              </button>
            </div>

            @if (showMeetingForm()) {
              <div class="meeting-form">
                <input 
                  type="text" 
                  [(ngModel)]="newMeeting.title" 
                  placeholder="Название встречи"
                  class="form-control">
                <textarea 
                  [(ngModel)]="newMeeting.description" 
                  placeholder="Описание (необязательно)"
                  rows="2"
                  class="form-control"></textarea>
                <input 
                  type="datetime-local" 
                  [(ngModel)]="newMeeting.meetingDate"
                  class="form-control">
                <input 
                  type="text" 
                  [(ngModel)]="newMeeting.location" 
                  placeholder="Место встречи"
                  class="form-control">
                <select [(ngModel)]="newMeeting.meetingType" class="form-control">
                  <option value="call">Звонок</option>
                  <option value="email">Email</option>
                  <option value="meeting">Встреча</option>
                  <option value="visit">Визит</option>
                  <option value="other">Другое</option>
                </select>
                <div class="form-actions">
                  <button class="btn btn-primary" (click)="createMeeting()">Создать</button>
                  <button class="btn btn-secondary" (click)="showMeetingForm.set(false)">Отмена</button>
                </div>
              </div>
            }

            <div class="meetings-list">
              @if (leadMeetings().length > 0) {
                @for (meeting of leadMeetings(); track meeting.id) {
                  <div class="meeting-item" [class.completed]="meeting.completed">
                    <div class="meeting-checkbox">
                      <input 
                        type="checkbox" 
                        [checked]="meeting.completed"
                        (change)="toggleMeeting(meeting)">
                    </div>
                    <div class="meeting-content">
                      <div class="meeting-title">{{ meeting.title }}</div>
                      @if (meeting.description) {
                        <div class="meeting-description">{{ meeting.description }}</div>
                      }
                      <div class="meeting-meta">
                        <span class="meeting-date">
                          <i class="fas fa-calendar"></i> 
                          {{ formatDate(meeting.meetingDate) }}
                        </span>
                        @if (meeting.location) {
                          <span class="meeting-location">
                            <i class="fas fa-map-marker-alt"></i> 
                            {{ meeting.location }}
                          </span>
                        }
                        <span class="meeting-type">{{ getMeetingTypeLabel(meeting.meetingType) }}</span>
                        <span class="meeting-admin">{{ meeting.admin?.email || 'Админ' }}</span>
                      </div>
                    </div>
                    <button class="btn btn-sm btn-danger" (click)="deleteMeeting(meeting.id)">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                }
              } @else {
                <p class="empty-state">Встреч пока нет</p>
              }
            </div>
          </div>
        }

        <!-- Вкладка: История -->
        @if (activeTab() === 'activity') {
          <div class="info-section">
            <h3>История изменений</h3>
            <div class="activity-list">
              @if (leadActivities().length > 0) {
                @for (activity of leadActivities(); track activity.id) {
                  <div class="activity-item">
                    <div class="activity-icon">
                      <i class="fas" [ngClass]="getActivityIcon(activity.activityType)"></i>
                    </div>
                    <div class="activity-content">
                      <div class="activity-description">
                        @if (activity.description) {
                          {{ activity.description }}
                        } @else {
                          {{ getActivityDescription(activity) }}
                        }
                      </div>
                      <div class="activity-meta">
                        <span>{{ activity.admin?.email || 'Система' }}</span>
                        <span>{{ formatDate(activity.createdAt) }}</span>
                      </div>
                    </div>
                  </div>
                }
              } @else {
                <p class="empty-state">История пуста</p>
              }
            </div>
          </div>
        }
      </div>

      <div class="modal-footer">
        <div class="footer-actions">
          <button class="btn btn-secondary" (click)="closeDetailsModal()">Закрыть</button>
          <button class="btn btn-primary" (click)="openEditModal(lead)">Редактировать</button>
          @if (!lead.convertedToClient) {
            <button class="btn btn-success" (click)="convertToClient()">
              <i class="fas fa-check-circle"></i> Конвертировать в клиента
            </button>
          }
        </div>
      </div>
    </div>
  </div>
  }
}
